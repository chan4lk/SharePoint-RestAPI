var App;(function(){"use strict";angular.module("app",[])})(App||(App={})),function(n){var t=function(){function n(){}return n.Include=function(n){return"Include("+n.join(",")+")"},n.getQueryStringParameter=function(n,t){t||(t=window.location.href);n=n.replace(/[\[\]]/g,"\\$&");var r=new RegExp("[?&]"+n+"(=([^&#]*)|&|#|$)"),i=r.exec(t);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null},n}();n.Utils=t}(App||(App={})),function(n){"use strict";var t=function(){function t(){}return Object.defineProperty(t,"URL",{get:function(){return{product:"http://services.odata.org/V4/Northwind/Northwind.svc/Products",category:"http://services.odata.org/V4/Northwind/Northwind.svc/Categories",supplier:"http://services.odata.org/V4/Northwind/Northwind.svc/Suppliers",appweb:decodeURIComponent(n.Utils.getQueryStringParameter("SPAppWebUrl")),hostWeb:decodeURIComponent(n.Utils.getQueryStringParameter("SPHostUrl"))}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"STATUS",{get:function(){return{OK:200}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"FormDigest",{get:function(){return document.getElementById("__REQUESTDIGEST").value},enumerable:!0,configurable:!0}),Object.defineProperty(t,"FIELD",{get:function(){return{supplier:{id:"SupplierID",companyName:"CompanyName"},product:{id:"ProductID",name:"ProductName",supplierId:"SupplierID",categoryId:"CategoryID"},category:{id:"CategoryID",name:"CategoryName"},review:{companyName:"CompanyName",productName:"ProductName"}}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"LIST",{get:function(){return{product:"Product",category:"Category",supplier:"Supplier",review:"Review"}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"HTTP",{get:function(){return{GET:"GET",POST:"POST",PATCH:"PATCH",PUT:"PUT",DELETE:"DELETE",MERGE:"MERGE"}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"FieldsConfig",{get:function(){var n=[{displayName:t.FIELD.category.id,name:t.FIELD.category.id,type:SP.FieldType.integer},{displayName:t.FIELD.category.name,name:t.FIELD.category.name,type:SP.FieldType.text}],i=[{displayName:t.FIELD.supplier.id,name:t.FIELD.supplier.id,type:SP.FieldType.integer},{displayName:t.FIELD.supplier.companyName,name:t.FIELD.supplier.companyName,type:SP.FieldType.text}],r=[{displayName:t.FIELD.product.id,name:t.FIELD.product.id,type:SP.FieldType.integer},{displayName:t.FIELD.product.name,name:t.FIELD.product.name,type:SP.FieldType.text},{displayName:t.FIELD.product.supplierId,name:t.FIELD.product.supplierId,type:SP.FieldType.integer},{displayName:t.FIELD.product.categoryId,name:t.FIELD.product.categoryId,type:SP.FieldType.integer}];return{Product:r,Category:n,Supplier:i}},enumerable:!0,configurable:!0}),t}();n.Constants=t;angular.module("app")}(App||(App={})),function(n){var f=function(){function n(n,t){this.SupplierID=n;this.CompanyName=t}return n.From=function(t){return new n(t.SupplierID,t.CompanyName)},n}(),t,i,r,u;n.Supplier=f;t=function(){function n(n,t){this.CategoryID=n;this.CategoryName=t}return n.From=function(t){return new n(t.CategoryID,t.CategoryName)},n}();n.Category=t;i=function(){function n(n,t,i,r){this.ProductID=n;this.ProductName=t;this.CategoryID=r;this.SupplierID=i}return n.From=function(t){return new n(t.ProductID,t.ProductName,t.SupplierID,t.CategoryID)},n.prototype.setCategory=function(n){for(var t=0;t<n.length;t++)if(n[t].CategoryID===this.CategoryID){this.Category=n[t];break}this.CategoryName=this.Category.CategoryName},n.prototype.setSupplier=function(n){for(var t=0;t<n.length;t++)if(n[t].SupplierID===this.SupplierID){this.Supplier=n[t];break}this.CompanyName=this.Supplier.CompanyName},n.prototype.resolve=function(n,t){this.setCategory(n);this.setSupplier(t)},n}();n.Product=i;r=function(){function n(n,t,i){this.Categories=t;this.Suppliers=i;this.Products=n}return n}();n.ListData=r;u=function(){function n(n,t){this.ProductName=n;this.SupplierName=t}return n}();n.Review=u}(App||(App={})),function(n){"use strict";var t=function(){function t(n,t){this.$http=n;this.$q=t}return t.prototype.getRequest=function(t){var i=this.$q.defer();return this.$http({url:t,headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose"},method:n.Constants.HTTP.GET}).then(function(n){i.resolve(n)}).catch(function(n){i.reject(n)}),i.promise},t.prototype.postRequest=function(t,i){var r=this.$q.defer();return this.$http({url:t,headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":n.Constants.FormDigest},method:n.Constants.HTTP.POST,data:i}).then(function(n){r.resolve(n)}).catch(function(n){r.reject(n)}),r.promise},t.prototype.mergeRequest=function(t,i){var r=this.$q.defer();return this.$http({url:t,headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":n.Constants.FormDigest,"X-HTTP-Method":n.Constants.HTTP.MERGE,"IF-Match":"*"},method:n.Constants.HTTP.POST,data:i}).then(function(n){r.resolve(n)}).catch(function(n){r.reject(n)}),r.promise},t.prototype.deleteRequest=function(t){var i=this.$q.defer();return this.$http({url:t,headers:{"X-RequestDigest":n.Constants.FormDigest,"X-HTTP-Method":n.Constants.HTTP.DELETE},method:n.Constants.HTTP.POST}).then(function(n){i.resolve(n)}).catch(function(n){i.reject(n)}),i.promise},t.prototype.proxyRequest=function(t){var i=this.$q.defer();return this.$http({url:"../_api/SP.WebProxy.invoke",method:n.Constants.HTTP.POST,data:JSON.stringify({requestInfo:{__metadata:{type:"SP.WebRequestInfo"},Url:t,Method:n.Constants.HTTP.GET,Headers:{results:[{__metadata:{type:"SP.KeyValue"},Key:"Content-Type",Value:"application/json;odata=verbose",ValueType:"Edm.String"}]}}}),headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":n.Constants.FormDigest}}).then(function(t){var r=t.data.d.Invoke.StatusCode,u;r==n.Constants.STATUS.OK?(u=JSON.parse(t.data.d.Invoke.Body).value,i.resolve(u)):i.reject(r)}).catch(function(n){i.reject(n)}),i.promise},t.$inject=["$http","$q"],t}();n.BaseService=t;angular.module("app").service("baseService",t)}(App||(App={})),function(n){"use strict";var t=function(){function t(t){this.$q=t;this.executor=new SP.RequestExecutor(n.Constants.URL.appweb)}return t.prototype.getRequest=function(t){var i=this.$q.defer();return this.executor.executeAsync({url:t,headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose"},method:n.Constants.HTTP.GET,Uint8Array:[],success:function(t){if(t.statusCode===n.Constants.STATUS.OK){var r=JSON.parse(t.body);i.resolve(r)}else i.reject(t.statusCode)},error:function(n){i.reject(n)}}),i.promise},t.prototype.postRequest=function(t,i){var r=this.$q.defer();return this.executor.executeAsync({url:t,headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":n.Constants.FormDigest},method:n.Constants.HTTP.POST,body:JSON.stringify(i),Uint8Array:[],success:function(n){r.resolve(JSON.parse(n.body))},error:function(n){r.reject(n)}}),r.promise},t.prototype.mergeRequest=function(t,i){var r=this.$q.defer();return this.executor.executeAsync({url:t,headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":n.Constants.FormDigest,"X-HTTP-Method":n.Constants.HTTP.MERGE,"IF-Match":"*"},method:n.Constants.HTTP.POST,body:JSON.stringify(i),Uint8Array:[],success:function(n){r.resolve(JSON.parse(n.body))},error:function(n){r.reject(n)}}),r.promise},t.prototype.deleteRequest=function(t){var i=this.$q.defer();return this.executor.executeAsync({url:t,headers:{"X-RequestDigest":n.Constants.FormDigest,"X-HTTP-Method":n.Constants.HTTP.DELETE},method:n.Constants.HTTP.POST,Uint8Array:[],success:function(n){i.resolve(n)},error:function(n){i.reject(n)}}),i.promise},t.prototype.proxyRequest=function(t){var i=this.$q.defer();return this.executor.executeAsync({url:"../_api/SP.WebProxy.invoke",method:n.Constants.HTTP.POST,body:JSON.stringify({requestInfo:{__metadata:{type:"SP.WebRequestInfo"},Url:t,Method:n.Constants.HTTP.GET,Headers:{results:[{__metadata:{type:"SP.KeyValue"},Key:"Content-Type",Value:"application/json;odata=verbose",ValueType:"Edm.String"}]}}}),headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":n.Constants.FormDigest},Uint8Array:[],success:function(t){var r=t.data.d.Invoke.StatusCode,u;r==n.Constants.STATUS.OK?(u=JSON.parse(t.data.d.Invoke.Body).value,i.resolve(u)):i.reject(r)},error:function(n){i.reject(n)}}),i.promise},t.$inject=["$q"],t}();n.ExecutorService=t;angular.module("app").service("executorService",t)}(App||(App={})),function(n){"use strict";var t=function(){function t(t,i,r,u){this.$http=t;this.$q=i;this.baseSvc=r;this.execSvc=u;this.context=SP.ClientContext.get_current();this.productURL=n.Constants.URL.appweb+"/_api/lists/getbytitle('"+n.Constants.LIST.product+"')/items?$select=ProductID,CategoryID,SupplierID,ProductName";this.categoryURL=n.Constants.URL.appweb+"/_api/lists/getbytitle('"+n.Constants.LIST.category+"')/items?$select=CategoryID,CategoryName";this.supplierURL=n.Constants.URL.appweb+"/_api/lists/getbytitle('"+n.Constants.LIST.supplier+"')/items?$select=SupplierID,CompanyName";this.reviewURL=n.Constants.URL.appweb+"/_api/SP.AppContextSite(@target)/web/lists/getbytitle('"+n.Constants.LIST.review+"')/items?@target='"+n.Constants.URL.hostWeb+"'"}return t.prototype.getUserName=function(){var n=this.$q.defer(),t=this.context.get_web();return this.context.load(t.get_currentUser()),this.context.executeQueryAsync(function(){var i=t.get_currentUser().get_userId();n.resolve(i)},function(t,i){n.reject(i.get_message())}),n.promise},t.prototype.getProducts=function(){return this.getItems(this.productURL)},t.prototype.getCategories=function(){return this.getItems(this.categoryURL)},t.prototype.getSuppliers=function(){return this.getItems(this.supplierURL)},t.prototype.getAll=function(){var n=this.$q.defer();return this.$q.all([this.getProducts(),this.getCategories(),this.getSuppliers()]).then(function(t){var i={Products:t[0],Categories:t[1],Suppliers:t[2]};n.resolve(i)}).catch(function(t){n.reject(t)}),n.promise},t.prototype.getItems=function(n){var t=this.$q.defer();return this.baseSvc.getRequest(n).then(function(n){t.resolve(n.data.d.results)}).catch(function(n){t.reject(n)}),t.promise},t.prototype.LoadExternal=function(){var r=this,i=this.$q.defer(),u=[n.Constants.URL.category,n.Constants.URL.supplier,n.Constants.URL.product],t;return this.baseSvc.proxyRequest(n.Constants.URL.supplier).then(function(u){r.baseSvc.proxyRequest(n.Constants.URL.category).then(function(f){r.baseSvc.proxyRequest(n.Constants.URL.product).then(function(n){var t={Products:n,Categories:f,Suppliers:u};i.resolve(t)}).catch(t)}).catch(t)}).catch(t),t=function(n){i.reject(n)},i.promise},t.prototype.addData=function(n){var t=this,i=this.$q.defer(),r=this.$q.when(!1),u=this.$q.when(!1),f=this.$q.when(!1);return n.Products.forEach(function(n){var i={__metadata:{type:"SP.Data.ProductListItem"},ProductID:n.ProductID,ProductName:n.ProductName,CategoryID:n.CategoryID,SupplierID:n.SupplierID};r=r.then(function(){return t.addItem(i,t.productURL)})}),n.Categories.forEach(function(n){var i={__metadata:{type:"SP.Data.CategoryListItem"},CategoryID:n.CategoryID,CategoryName:n.CategoryName};u=u.then(function(){return t.addItem(i,t.categoryURL)})}),n.Suppliers.forEach(function(n){var i={__metadata:{type:"SP.Data.SupplierListItem"},SupplierID:n.SupplierID,CompanyName:n.CompanyName};f=f.then(function(){return t.addItem(i,t.supplierURL)})}),this.$q.all([r,u,f]).then(function(){i.resolve(!0)}).catch(function(){i.reject(!1)}),i.promise},t.prototype.addItem=function(n,t){return this.baseSvc.postRequest(t,n)},t.prototype.loadData=function(){var n=this.$q.defer();return n.promise},t.prototype.addReview=function(n){var t={__metadata:{type:"SP.Data.ReviewListItem"},ProductName:n.ProductName,CompanyName:n.SupplierName};return this.execSvc.postRequest(this.reviewURL,t)},t.$inject=["$http","$q","baseService","executorService"],t}();angular.module("app").service("dataSvc",t)}(App||(App={})),function(n){"use strict";var t=function(){function t(t,i){this.$q=t;this.$execSvc=i;this.appWebUrl=n.Constants.URL.appweb;this.hostWebUrl=n.Constants.URL.hostWeb;this.context=SP.ClientContext.get_current()}return t.prototype.createLists=function(n){var i=this,t=this.$q.when(!1);return n.forEach(function(n){t=t.then(function(){return i.createList(n)})}),t},t.prototype.getHostList=function(n){var t=this.$q.defer(),i=this.appWebUrl+"/_api/SP.AppContextSite(@target)/web/lists?$select=Title,Id&@target='"+this.hostWebUrl+"'";return this.$execSvc.getRequest(i).then(function(i){for(var f,r=i.d.results,e=[],u=0;u<r.length;u++)e.push(r[u].Title);f=Enumerable.From(r).Where(function(t){return t.Title==n}).Select(function(n){return n}).SingleOrDefault(null);f!=null?t.resolve(f.Id):t.resolve(!1)}).catch(function(n){t.reject(n.statusCode)}),t.promise},t.prototype.createHostList=function(n){var t=this.$q.defer(),i=this.appWebUrl+"/_api/SP.AppContextSite(@target)/web/lists?@target='"+this.hostWebUrl+"'",r={__metadata:{type:"SP.List"},BaseTemplate:SP.ListTemplateType.genericList,Description:n+" list",Title:n};return this.$execSvc.postRequest(i,r).then(function(n){var i=n.d;i!=null?t.resolve(i.Id):t.reject(!1)}).catch(function(n){t.reject(n.statusCode)}),t.promise},t.prototype.createList=function(n){var t=this.$q.defer(),i=this.appWebUrl+"/_api/Web/Lists",r={__metadata:{type:"SP.List"},BaseTemplate:SP.ListTemplateType.genericList,Description:n+" list",Title:n,AllowContentTypes:!0,ContentTypesEnabled:!0};return this.$execSvc.postRequest(i,r).then(function(n){var i=n.d.Id;typeof i!==undefined&&t.resolve(!0)}).catch(function(n){t.reject(n)}),t.promise},t.prototype.getLists=function(){var n=this.$q.defer(),t=this.appWebUrl+"/_api/Web/Lists?$select=Title,Id";return this.$execSvc.getRequest(t).then(function(t){var i=t.d.results;n.resolve(i)}).catch(function(t){n.reject(t)}),n.promise},t.prototype.getFormDigest=function(){var n=this.$q.defer(),t=this.appWebUrl+"/_api/contextInfo";return this.$execSvc.postRequest(t,{}).then(function(t){var i=t.d;n.resolve(i.GetContextWebInformation.FormDigestValue)}).catch(function(t){n.reject(t)}),n.promise},t.prototype.addFields=function(n,t,i){var u=this,r=this.$q.when(!1);return t.forEach(function(t){r=r.then(function(){return u.addField(n,t,i)})}),r},t.prototype.addField=function(t,i,r){var u=this.$q.defer(),o=n.Constants.FormDigest,f=this.appWebUrl+"/_api/Web/Lists(guid'"+t+"')/fields",e;return r&&(f=n.Constants.URL.appweb+"/_api/SP.AppContextSite(@target)/web/Lists(guid'"+t+"')/fields?@target='"+n.Constants.URL.hostWeb+"'"),e=new SP.RequestExecutor(n.Constants.URL.appweb),e.executeAsync({headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":o,"X-AddField":"true"},body:JSON.stringify({__metadata:{type:"SP.Field"},FieldTypeKind:i.type,Title:i.name}),method:n.Constants.HTTP.POST,url:f,success:function(n){var t=n.headers;u.resolve(t)},error:function(n){u.reject(n)},Uint8Array:[]}),u.promise},t.$inject=["$q","executorService"],t}();n.ListService=t;angular.module("app").service("ListService",t)}(App||(App={})),function(n){"use strict";var t=function(){function t(t,i,r){var u=this;this.$scope=t;this.dataService=i;this.listService=r;this.getFormDigest=function(){u.listService.getFormDigest().then(function(n){u.$scope.formDigestValue=n}).catch(function(n){alert("failed request "+n)})};this.activate=function(n){u.$scope.userName=n;u.$scope.$apply()};this.addFields=function(t){if(typeof u.$scope.listInfo==undefined)u.listService.getLists().then(function(n){u.$scope.listInfo=n;u.addFields(t)});else{var i=0;t.forEach(function(r){var e=Enumerable.From(u.$scope.listInfo).Where(function(n){return n.Title===r}).Select(function(n){return n.Id}).SingleOrDefault(null),f;e!=null&&(console.log("adding field to list "+e),f=[],r===n.Constants.LIST.category?f=n.Constants.FieldsConfig.Category:r===n.Constants.LIST.supplier?f=n.Constants.FieldsConfig.Supplier:r===n.Constants.LIST.product&&(f=n.Constants.FieldsConfig.Product),u.listService.addFields(e,f).then(function(){console.log("fields inserted");i++;i==t.length&&u.loadExternalData()}).catch(function(n){console.log(n);alert(n)}))})}};t.title="Supply System with Angular";t.userName="";t.review=!1;t.addFields=this.addFields;t.AddReview=function(){u.addReview()};t.clearSearch=function(){u.clearSearch()};this.displayUserName();this.createAppWebLists();this.createReview()}return t.prototype.clearSearch=function(){for(var n in this.$scope.search)this.$scope.search[n]=undefined},t.prototype.displayUserName=function(){var n=this;this.dataService.getUserName().then(function(t){n.$scope.userName=t}).catch(function(n){alert(n)})},t.prototype.loadExternalData=function(){var n=this;this.dataService.LoadExternal().then(function(t){n.dataService.addData(t).then(function(){console.log("data inserted");n.loadListData()})})},t.prototype.loadListData=function(){var t=this;this.dataService.getAll().then(function(i){console.log("All the data loaded from odata");var r=[];i.Products.forEach(function(t){var u=new n.Product(t.ProductID,t.ProductName,t.SupplierID,t.CategoryID);u.resolve(i.Categories,i.Suppliers);r.push(u)});t.$scope.Products=r})},t.prototype.createAppWebLists=function(){var t=this,i=[n.Constants.LIST.category,n.Constants.LIST.supplier,n.Constants.LIST.product];this.listService.getLists().then(function(n){var u,r;t.$scope.listInfo=n;u=Enumerable.From(n).Select(function(n){return n.Title}).ToArray();t.$scope.lists=u.join(",");r=Enumerable.From(i).Except(Enumerable.From(u).Intersect(i)).ToArray();r.length>0?t.listService.createLists(r).then(function(){console.log("Create lists "+r.join(", "));t.listService.getLists().then(function(n){t.$scope.listInfo=n;t.addFields(r)}).catch(function(n){alert("could not load lists "+n)})}).catch(function(n){alert("could not create lists "+n)}):(console.log(i.join(", ")+" lists already exists"),t.loadListData())}).catch(function(n){console.log(n);alert("couldn't recive list data "+n)})},t.prototype.createReview=function(){var t=this;this.listService.getHostList(n.Constants.LIST.review).then(function(i){t.$scope.review=i;i||t.listService.createHostList(n.Constants.LIST.review).then(function(n){console.log("Review List Created");t.$scope.review=!0;t.addReviewFields(n)}).catch(function(n){alert("could not create list review "+n)})})},t.prototype.addReviewFields=function(t){var i=[{displayName:n.Constants.FIELD.review.companyName,name:n.Constants.FIELD.review.companyName,type:SP.FieldType.text},{displayName:n.Constants.FIELD.review.productName,name:n.Constants.FIELD.review.productName,type:SP.FieldType.text}];this.listService.addFields(t,i,!0).then(function(){console.log("Review list fields added")}).catch(function(n){console.log(n);alert("Review list fields adding fields")})},t.prototype.addReview=function(){for(var n=document.querySelectorAll('input.review[type="checkbox"]:checked'),r=0,t=0;t<n.length;t++){var i=n.item(t),u=Enumerable.From(this.$scope.Products).Where(function(n){return n.ProductID.toString()==i.value}).SingleOrDefault(null),f={ProductName:u.ProductName,SupplierName:u.CompanyName};this.dataService.addReview(f).then(function(){r++;r===n.length&&alert("Review(s) Added")}).catch(function(n){console.error(n)});i.checked=!1;i.removeAttribute("checked")}},t.$inject=["$scope","dataSvc","ListService"],t}();angular.module("app").controller("mainCtrl",t)}(App||(App={}));
/*
//# sourceMappingURL=app.min.js.map
*/
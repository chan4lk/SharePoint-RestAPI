var App;(function(){"use strict";angular.module("app",[])})(App||(App={})),function(n){var t=function(){function n(){}return n.Include=function(n){return"Include("+n.join(",")+")"},n.getQueryStringParameter=function(n,t){t||(t=window.location.href);n=n.replace(/[\[\]]/g,"\\$&");var r=new RegExp("[?&]"+n+"(=([^&#]*)|&|#|$)"),i=r.exec(t);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null},n}();n.Utils=t}(App||(App={})),function(n){"use strict";var t=function(){function t(){}return Object.defineProperty(t,"URL",{get:function(){return{product:"http://services.odata.org/V4/Northwind/Northwind.svc/Products",category:"http://services.odata.org/V4/Northwind/Northwind.svc/Categories",supplier:"http://services.odata.org/V4/Northwind/Northwind.svc/Suppliers",appweb:decodeURIComponent(n.Utils.getQueryStringParameter("SPAppWebUrl")),hostWeb:decodeURIComponent(n.Utils.getQueryStringParameter("SPHostUrl"))}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"FormDigest",{get:function(){return document.getElementById("__REQUESTDIGEST").value},enumerable:!0,configurable:!0}),Object.defineProperty(t,"FIELD",{get:function(){return{supplier:{id:"SupplierID",companyName:"CompanyName"},product:{id:"ProductID",name:"ProductName",supplierId:"SupplierID",categoryId:"CategoryID"},category:{id:"CategoryID",name:"CategoryName"},review:{companyName:"CompanyName",productName:"ProductName"}}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"LIST",{get:function(){return{product:"Product",category:"Category",supplier:"Supplier",review:"Review"}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"HTTP",{get:function(){return{GET:"GET",POST:"POST",PATCH:"PATCH",PUT:"PUT",DELETE:"DELETE",MERGE:"MERGE"}},enumerable:!0,configurable:!0}),t}();n.Constants=t;angular.module("app")}(App||(App={})),function(n){var f=function(){function n(n,t){this.ID=n;this.CompanyName=t}return n.From=function(t){return new n(t.ID,t.CompanyName)},n}(),t,i,r,u;n.Supplier=f;t=function(){function n(n,t){this.ID=n;this.Name=t}return n.From=function(t){return new n(t.ID,t.Name)},n}();n.Category=t;i=function(){function n(n,t,i,r){this.ID=n;this.ProductName=t;this.CategoryID=r;this.SupplierID=i}return n.From=function(t){return new n(t.ID,t.ProductName,t.SupplierID,t.CategoryID)},n.prototype.setCategory=function(n){for(var t=0;t<n.length;t++)if(n[t].ID===this.CategoryID){this.Category=n[t];break}},n.prototype.setSupplier=function(n){for(var t=0;t<n.length;t++)if(n[t].ID===this.SupplierID){this.Supplier=n[t];break}},n.prototype.resolve=function(n,t){this.setCategory(n);this.setSupplier(t)},n}();n.Product=i;r=function(){function n(n,t,i){this.Categories=t;this.Suppliers=i;this.Products=n}return n}();n.ListData=r;u=function(){function n(n,t){this.ProductName=n;this.SupplierName=t}return n}();n.Review=u}(App||(App={})),function(n){"use strict";var t=function(){function t(n,t){this.$http=n;this.$q=t;this.context=SP.ClientContext.get_current()}return t.prototype.getUserName=function(){var n=this.$q.defer(),t=this.context.get_web();return this.context.load(t.get_currentUser()),this.context.executeQueryAsync(function(){var i=t.get_currentUser().get_userId();n.resolve(i)},function(t,i){n.reject(i.get_message())}),n.promise},t.prototype.getProducts=function(){var i=this.$q.defer(),r=[],f=this.context.get_web().get_lists(),e=f.getByTitle(n.Constants.LIST.product),u=new SP.CamlQuery,o=(new CamlBuilder).View().ToString(),t;return u.set_viewXml(o),t=e.getItems(u),this.context.load(t,n.Utils.Include([n.Constants.FIELD.product.id,n.Constants.FIELD.product.name,n.Constants.FIELD.product.categoryId,n.Constants.FIELD.product.supplierId])),this.context.executeQueryAsync(function(){for(var f,e,o=t.get_count(),u=0;u<o;u++)f=t.itemAt(u),e=f.get_fieldValues(),r.push(n.Product.From(e));i.resolve(r)},function(n,t){i.reject(t.get_message())}),i.promise},t.prototype.getCategories=function(){var r=[],i=this.$q.defer(),f=this.context.get_web().get_lists(),e=f.getByTitle(n.Constants.LIST.category),u=new SP.CamlQuery,o=(new CamlBuilder).View().ToString(),t;return u.set_viewXml(o),t=e.getItems(u),this.context.load(t,n.Utils.Include([n.Constants.FIELD.category.id,n.Constants.FIELD.category.name])),this.context.executeQueryAsync(function(){for(var f,e,o=t.get_count(),u=0;u<o;u++)f=t.itemAt(u),e=f.get_fieldValues(),r.push(n.Category.From(e));i.resolve(r)},function(n,t){i.reject(t.get_message())}),i.promise},t.prototype.getSuppliers=function(){var r=[],i=this.$q.defer(),f=this.context.get_web().get_lists(),e=f.getByTitle(n.Constants.LIST.supplier),u=new SP.CamlQuery,o=(new CamlBuilder).View().ToString(),t;return u.set_viewXml(o),t=e.getItems(u),this.context.load(t,n.Utils.Include([n.Constants.FIELD.supplier.id,n.Constants.FIELD.supplier.companyName])),this.context.executeQueryAsync(function(){for(var f,e,o=t.get_count(),u=0;u<o;u++)f=t.itemAt(u),e=f.get_fieldValues(),r.push(n.Supplier.From(e));i.resolve(r)},function(n,t){i.reject(t.get_message())}),i.promise},t.prototype.getAll=function(){var r=this.$q.defer(),u=[],f=this.context.get_web().get_lists(),s=f.getByTitle(n.Constants.LIST.product),h=f.getByTitle(n.Constants.LIST.category),c=f.getByTitle(n.Constants.LIST.supplier),i=new SP.CamlQuery,l=(new CamlBuilder).View().ToString(),t,o,e;return i.set_viewXml(l),t=s.getItems(i),this.context.load(t,n.Utils.Include([n.Constants.FIELD.product.id,n.Constants.FIELD.product.name,n.Constants.FIELD.product.categoryId,n.Constants.FIELD.product.supplierId])),o=c.getItems(i),this.context.load(o,n.Utils.Include([n.Constants.FIELD.supplier.id,n.Constants.FIELD.supplier.companyName])),e=h.getItems(i),this.context.load(e,n.Utils.Include([n.Constants.FIELD.category.id,n.Constants.FIELD.category.name])),this.context.executeQueryAsync(function(){for(var f,o,s=t.get_count(),i=0;i<s;i++)f=t.itemAt(i),o=f.get_fieldValues(),u.push(n.Product.From(o));for(s=e.get_count(),i=0;i<s;i++)f=t.itemAt(i),o=f.get_fieldValues(),u.push(n.Product.From(o));r.resolve(u)},function(n,t){r.reject(t.get_message())}),r.promise},t.prototype.addData=function(){var n=this.$q.defer();return n.promise},t.prototype.loadData=function(){var n=this.$q.defer();return n.promise},t.prototype.addReview=function(){var n=this.$q.defer();return n.promise},t.$inject=["$http","$q"],t}();angular.module("app").service("dataSvc",t)}(App||(App={})),function(n){"use strict";var t=function(){function t(t,i){this.$http=t;this.$q=i;this.appWebUrl=n.Constants.URL.appweb;this.hostWebUrl=n.Constants.URL.hostWeb;this.context=SP.ClientContext.get_current()}return t.prototype.createLists=function(n){var i=this,t=this.$q.when(!1);return n.forEach(function(n){t=t.then(function(){return i.createList(n)})}),t},t.prototype.getHostList=function(t){var i=this.$q.defer(),r=new SP.RequestExecutor(this.appWebUrl);return r.executeAsync({url:this.appWebUrl+"/_api/SP.AppContextSite(@target)/web/lists?$select=Title,Id&@target='"+this.hostWebUrl+"'",method:n.Constants.HTTP.GET,headers:{Accept:"application/json; odata=verbose","X-RequestDigest":document.getElementById("__REQUESTDIGEST").value},success:function(n){for(var f,r=JSON.parse(n.body).d.results,e=[],u=0;u<r.length;u++)e.push(r[u].Title);f=Enumerable.From(r).Where(function(n){return n.Title==t}).Select(function(n){return n}).SingleOrDefault(null);f!=null?i.resolve(f.Id):i.resolve(!1)},error:function(n){i.reject(n.statusCode)},Uint8Array:[]}),i.promise},t.prototype.createHostList=function(t){var i=this.$q.defer(),r=new SP.RequestExecutor(this.appWebUrl);return r.executeAsync({url:this.appWebUrl+"/_api/SP.AppContextSite(@target)/web/lists?@target='"+this.hostWebUrl+"'",method:n.Constants.HTTP.POST,headers:{Accept:"application/json; odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":n.Constants.FormDigest},body:JSON.stringify({__metadata:{type:"SP.List"},BaseTemplate:SP.ListTemplateType.genericList,Description:t+" list",Title:t}),success:function(n){var t=JSON.parse(n.body).d;t!=null?i.resolve(t.Id):i.reject(!1)},error:function(n){i.reject(n.statusCode)},Uint8Array:[]}),i.promise},t.prototype.createList=function(t){var i=this.$q.defer(),r=n.Constants.FormDigest;return this.$http({url:this.appWebUrl+"/_api/Web/Lists",method:n.Constants.HTTP.POST,headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":r},data:JSON.stringify({__metadata:{type:"SP.List"},BaseTemplate:SP.ListTemplateType.genericList,Description:t+" list",Title:t,AllowContentTypes:!0,ContentTypesEnabled:!0})}).then(function(n){var t=n.data.d.id;typeof t!==undefined&&i.resolve(!0)}).catch(function(n){i.reject(n)}),i.promise},t.prototype.getLists=function(){var t=this.$q.defer();return this.$http({url:this.appWebUrl+"/_api/Web/Lists",method:n.Constants.HTTP.GET,headers:{Accept:"application/json;odata=verbose"}}).then(function(n){var i=n.data.d.results;t.resolve(i)}).catch(function(n){t.reject(n)}),t.promise},t.prototype.getFormDigest=function(){var t=this.$q.defer();return this.$http({url:this.appWebUrl+"/_api/contextInfo",method:n.Constants.HTTP.POST,headers:{Accept:"application/json;odata=verbose"}}).then(function(n){var i=n.data.d;t.resolve(i.GetContextWebInformation.FormDigestValue)}).catch(function(n){t.reject(n)}),t.promise},t.prototype.addFields=function(n,t,i){var u=this,r=this.$q.when(!1);return t.forEach(function(t){r=r.then(function(){return u.addField(n,t,i)})}),r},t.prototype.addField=function(t,i,r){var u=this.$q.defer(),o=n.Constants.FormDigest,f=this.appWebUrl+"/_api/Web/Lists(guid'"+t+"')/fields",e;return r&&(f=n.Constants.URL.appweb+"/_api/SP.AppContextSite(@target)/web/Lists(guid'"+t+"')/fields?@target='"+n.Constants.URL.hostWeb+"'"),e=new SP.RequestExecutor(n.Constants.URL.appweb),e.executeAsync({headers:{Accept:"application/json;odata=verbose","Content-Type":"application/json;odata=verbose","X-RequestDigest":o,"X-AddField":"true"},body:JSON.stringify({__metadata:{type:"SP.Field"},FieldTypeKind:i.type,Title:i.name}),method:n.Constants.HTTP.POST,url:f,success:function(n){var t=n.headers;u.resolve(t)},error:function(n){u.reject(n)},Uint8Array:[]}),u.promise},t.$inject=["$http","$q"],t}();angular.module("app").service("ListService",t)}(App||(App={})),function(n){"use strict";var t=function(){function t(t,i,r){var u=this;this.$scope=t;this.dataService=i;this.listService=r;this.getFormDigest=function(){u.listService.getFormDigest().then(function(n){u.$scope.formDigestValue=n}).catch(function(n){alert("failed request "+n)})};this.activate=function(n){u.$scope.userName=n;u.$scope.$apply()};this.addFields=function(t){typeof u.$scope.listInfo==undefined?u.listService.getLists().then(function(n){u.$scope.listInfo=n;u.addFields(t)}):t.forEach(function(t){var r=Enumerable.From(u.$scope.listInfo).Where(function(n){return n.Title===t}).Select(function(n){return n.Id}).SingleOrDefault(null),i;r!=null&&(console.log("adding field to list "+r),i=[],t===n.Constants.LIST.category?i=[{displayName:n.Constants.FIELD.category.id,name:n.Constants.FIELD.category.id,type:SP.FieldType.integer},{displayName:n.Constants.FIELD.category.name,name:n.Constants.FIELD.category.name,type:SP.FieldType.text}]:t===n.Constants.LIST.supplier?i=[{displayName:n.Constants.FIELD.supplier.id,name:n.Constants.FIELD.supplier.id,type:SP.FieldType.integer},{displayName:n.Constants.FIELD.supplier.companyName,name:n.Constants.FIELD.supplier.companyName,type:SP.FieldType.text}]:t===n.Constants.LIST.product&&(i=[{displayName:n.Constants.FIELD.product.id,name:n.Constants.FIELD.product.id,type:SP.FieldType.integer},{displayName:n.Constants.FIELD.product.name,name:n.Constants.FIELD.product.name,type:SP.FieldType.text},{displayName:n.Constants.FIELD.product.supplierId,name:n.Constants.FIELD.product.supplierId,type:SP.FieldType.integer},{displayName:n.Constants.FIELD.product.categoryId,name:n.Constants.FIELD.product.categoryId,type:SP.FieldType.integer}]),u.listService.addFields(r,i).then(function(){console.log(n.Constants.FIELD.category.id+" field inserted")}).catch(function(n){console.log(n);alert(n)}))})};t.title="Supply System with Angular";t.userName="";t.review=!1;t.addFields=this.addFields;this.displayUserName();this.createAppWebLists();this.createReview()}return t.prototype.displayUserName=function(){var n=this;this.dataService.getUserName().then(function(t){n.$scope.userName=t}).catch(function(n){alert(n)})},t.prototype.createAppWebLists=function(){var t=this,i=[n.Constants.LIST.category,n.Constants.LIST.supplier,n.Constants.LIST.product];this.listService.getLists().then(function(n){var u,r;t.$scope.listInfo=n;u=Enumerable.From(n).Select(function(n){return n.Title}).ToArray();t.$scope.lists=u.join(",");r=Enumerable.From(i).Except(Enumerable.From(u).Intersect(i)).ToArray();r.length>0?t.listService.createLists(r).then(function(){console.log("Create lists "+r.join(", "));t.listService.getLists().then(function(n){t.$scope.listInfo=n;t.addFields(r)}).catch(function(n){alert("could not load lists "+n)})}).catch(function(n){alert("could not create lists "+n)}):console.log(i.join(", ")+" lists already exists")}).catch(function(n){console.log(n);alert("couldn't recive list data "+n)})},t.prototype.createReview=function(){var t=this;this.listService.getHostList(n.Constants.LIST.review).then(function(i){t.$scope.review=i;i||t.listService.createHostList(n.Constants.LIST.review).then(function(n){console.log("Review List Created");t.$scope.review=!0;t.addReviewFields(n)}).catch(function(n){alert("could not create list review "+n)})})},t.prototype.addReviewFields=function(t){var i=[{displayName:n.Constants.FIELD.review.companyName,name:n.Constants.FIELD.review.companyName,type:SP.FieldType.text},{displayName:n.Constants.FIELD.review.productName,name:n.Constants.FIELD.review.productName,type:SP.FieldType.text}];this.listService.addFields(t,i,!0).then(function(){console.log("Review list fields added")}).catch(function(n){console.log(n);alert("Review list fields adding fields")})},t.$inject=["$scope","dataSvc","ListService"],t}();angular.module("app").controller("mainCtrl",t)}(App||(App={}));
/*
//# sourceMappingURL=app.min.js.map
*/